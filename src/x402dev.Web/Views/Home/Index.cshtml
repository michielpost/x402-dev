@using Markdig
@using x402dev.Web.Services
@inject ContentService ContentService

@{
	ViewData["Title"] = "x402 Developer Portal";

	var facilitators = (await ContentService.GetFacilitators()).Where(x => x.Checked.HasValue);
	var content = await ContentService.GetProjects();
	var markdown = Markdown.ToHtml(content);
}

<section class="hero text-center py-5 mb-5">
	<div class="container">
		<h1 class="display-4 fw-bold mb-3">x402 Developer Portal</h1>
		<p class="lead mb-4">Discover live facilitators and a curated list of awesome x402 projects. Contribute your own and help the community grow.</p>
		<div class="d-flex gap-2 justify-content-center">
			<a class="btn btn-primary btn-lg" href="https://github.com/michielpost/x402-dev" target="_blank" rel="noopener">Add your project on GitHub</a>
			<a class="btn btn-outline-primary btn-lg" href="#projects">Browse Projects</a>
		</div>
	</div>
	<div class="hero-accent"></div>
</section>

<section id="facilitators" class="mb-5">
	<div class="container">
		<div class="d-flex align-items-baseline justify-content-between flex-wrap mb-3">
			<div class="d-flex align-items-baseline gap-3">
				<h2 class="h3 m-0">Facilitators</h2>
				<small class="text-body-secondary">Checked live and updated periodically</small>
			</div>
			<div class="d-flex gap-2">
				<a class="btn btn-sm btn-outline-primary" href="https://github.com/michielpost/x402-dev/blob/master/facilitators.json" target="_blank" rel="noopener">Add facilitator (edit JSON)</a>
			</div>
		</div>

		@if (facilitators?.Any() == true)
		{
			<div class="table-responsive">
				<table class="table table-dark table-striped align-middle cyber-table">
					<thead>
						<tr>
							<th scope="col">Name</th>
							<th scope="col">Status</th>
							<th scope="col" class="text-center" style="width:42px">Copy</th>
							<th scope="col">URL</th>
							<th scope="col">Networks</th>
							<th scope="col">Checked</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var facilitator in facilitators.OrderBy(f => f.HasError).ThenByDescending(f => f.Checked))
						{
							var isError = facilitator.HasError;
							var statusText = isError ? "Offline" : "Online";
							var statusClass = isError ? "badge bg-danger" : "badge bg-success";
							var checkedText = facilitator.Checked.HasValue ? facilitator.Checked.Value.ToLocalTime().ToString("g") : "—";

							<tr>

								<td class="fw-semibold">@facilitator.Name</td>
								<td><span class="@statusClass">@statusText</span></td>
								<td class="text-center">
									<button class="btn btn-link btn-sm p-0 align-baseline copy-btn" type="button" aria-label="Copy URL for @facilitator.Name" title="Copy URL" data-copy="@facilitator.Url">📋</button>
								</td>
								<td class="font-monospace"><a href="@facilitator.Url" target="_blank" rel="noopener">@facilitator.Url</a>
								
									@if(facilitator.Name == "Coinbase")
									{
										<p>Needs API key. Check the <a href="https://docs.cdp.coinbase.com/api-reference/v2/rest-api/x402-facilitator/x402-facilitator" target="_blank" rel="noopener">docs</a>.</p>
									}

								</td>
								<td class="small">
									@foreach (var kind in (facilitator.Kinds ?? new()).OrderBy(x => x.Network))
									{
										<span class="badge bg-secondary me-1 mb-1">@kind.Network</span>
									}
								</td>
								<td class="small">@checkedText</td>
							</tr>
						}
					</tbody>
				</table>
			</div>
		}
		else
		{
			<div class="alert alert-info">No facilitators available yet.</div>
		}
	</div>
</section>

<section id="facilitators" class="mb-5">
	<div class="container">
		<div class="d-flex align-items-baseline justify-content-between flex-wrap mb-3">
			<div>
				<h2 class="h3 m-0">Public Messages posted using x402</h2>
				<p>Launcing a new x402 project? Promote it here! Messages can only be posted using x402.</p>
				<p>See <a href="/swagger" target="_blank">Open API Specs</a> for API details. A payment of 0.1 USDC on Base is required.</p>
			</div>
		</div>

		@await Html.PartialAsync("Messages")
	</div>
</section>

<section id="projects" class="mb-5">
	<div class="container">
		<div class="d-flex align-items-baseline justify-content-between flex-wrap mb-3">
			<h2 class="h3 m-0">Awesome x402 Projects</h2>
			<a class="btn btn-sm btn-outline-primary" href="https://github.com/michielpost/x402-dev/blob/master/Projects.md" target="_blank" rel="noopener">Edit on GitHub</a>
		</div>
		<div class="card shadow-sm">
			<div class="card-body markdown-body">
				@Html.Raw(markdown)
			</div>
		</div>
		<div class="text-center mt-3">
			<a class="btn btn-primary" href="https://github.com/michielpost/x402-dev/blob/master/Projects.md" target="_blank" rel="noopener">Make a PR to add your project</a>
		</div>
	</div>
</section>

<section class="mb-5">
	<div class="container">
		<div class="text-center mt-3">
			<img src="~/logo.jpg" height="200" />
		</div>
	</div>
</section>