@using Markdig
@using x402dev.Web.Services
@inject ContentService ContentService

@{
	ViewData["Title"] = "x402 Developer Portal";

	var facilitators = (await ContentService.GetFacilitators()).Where(x => x.Checked.HasValue);
}

<section id="facilitators" class="mb-5">
	<div class="container">
		<div class="d-flex align-items-baseline justify-content-between flex-wrap mb-3">
			<div class="d-flex align-items-baseline gap-3">
				<h2 class="h3 m-0">Facilitators</h2>
				<small class="text-body-secondary">Checked live and updated periodically</small>
			</div>
			<div class="d-flex gap-2">
				<a class="btn btn-sm btn-outline-primary" href="https://github.com/michielpost/x402-dev/blob/master/facilitators.json" target="_blank" rel="noopener">Add facilitator (edit JSON)</a>
			</div>
		</div>

		@if (facilitators?.Any() == true)
		{
			<div class="table-responsive">
				<table class="table table-dark table-striped align-middle cyber-table">
					<thead>
						<tr>
							<th scope="col">Name</th>
							<th scope="col">Status</th>
							<th scope="col" class="text-center" style="width:42px">Copy</th>
							<th scope="col">URL</th>
							<th scope="col">Networks</th>
							<th scope="col">Checked</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var facilitator in facilitators.OrderBy(f => f.HasError).ThenByDescending(f => f.Checked))
						{
							var isError = facilitator.HasError;
							var statusText = isError ? "Offline" : "Online";
							var statusClass = isError ? "badge bg-danger" : "badge bg-success";
							var checkedText = facilitator.Checked.HasValue ? facilitator.Checked.Value.ToLocalTime().ToString("g") : "—";

							<tr>

								<td class="fw-semibold">@facilitator.Name</td>
								<td><span class="@statusClass">@statusText</span></td>
								<td class="text-center">
									<button class="btn btn-link btn-sm p-0 align-baseline copy-btn" type="button" aria-label="Copy URL for @facilitator.Name" title="Copy URL" data-copy="@facilitator.Url">📋</button>
								</td>
								<td class="font-monospace"><a href="@facilitator.Url" target="_blank" rel="noopener">@facilitator.Url</a>
								
									@if(facilitator.Name == "Coinbase")
									{
										<p>Needs API key. Check the <a href="https://docs.cdp.coinbase.com/api-reference/v2/rest-api/x402-facilitator/x402-facilitator" target="_blank" rel="noopener">docs</a>.</p>
									}

								</td>
								<td class="small">
									@foreach (var kind in (facilitator.Kinds ?? new()).OrderBy(x => x.Network))
									{
										<span class="badge bg-secondary me-1 mb-1">@kind.Network</span>
									}
								</td>
								<td class="small">@checkedText</td>
							</tr>
						}
					</tbody>
				</table>
			</div>
		}
		else
		{
			<div class="alert alert-info">No facilitators available yet.</div>
		}
	</div>
</section>

